name: Flutter CI/CD - Build & Test

on:
    push:
        branches: ["main", "develop"]
    pull_request:
        branches: ["main"]
    workflow_dispatch: # Allows manual trigger

jobs:
    build:
        name: Build & Test Flutter App
        runs-on: ubuntu-latest

        steps:
            # Step 1: Checkout the repository
            - name: ğŸ“¥ Checkout Repository
              uses: actions/checkout@v4

            # Step 2: Setup Java (Required for Android builds)
            - name: â˜• Setup Java
              uses: actions/setup-java@v3
              with:
                  distribution: "zulu"
                  java-version: "17"

            # Step 3: Setup Flutter
            - name: ğŸ¦ Setup Flutter SDK
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  cache: true

            # Step 4: Verify Flutter installation
            - name: ğŸ” Verify Flutter
              run: flutter --version

            # Step 5: Get dependencies
            - name: ğŸ“¦ Get Dependencies
              run: flutter pub get

            # Step 6: Run code analysis
            - name: ğŸ” Analyze Code
              run: flutter analyze
              continue-on-error: true

            # Step 7: Run tests
            - name: ğŸ§ª Run Tests
              run: flutter test

            # Step 8: Build Debug APK
            - name: ğŸ”¨ Build Debug APK
              run: flutter build apk --debug

            # Step 9: Build Release APK
            - name: ğŸ—ï¸ Build Release APK
              run: flutter build apk --release

            # Step 10: Upload Debug APK
            - name: ğŸ“¤ Upload Debug APK
              uses: actions/upload-artifact@v4
              with:
                  name: debug-apk
                  path: build/app/outputs/flutter-apk/app-debug.apk

            # Step 11: Upload Release APK
            - name: ğŸ“¤ Upload Release APK
              uses: actions/upload-artifact@v4
              with:
                  name: release-apk
                  path: build/app/outputs/flutter-apk/app-release.apk
# ==========================================
# OPTIONAL: Signed Release APK Build
# ==========================================
# To enable signed APK builds:
# 1. Create a keystore file
# 2. Add GitHub Secrets: KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD
# 3. Uncomment the job below

#  build-signed:
#    name: Build Signed APK
#    runs-on: ubuntu-latest
#    needs: build
#
#    steps:
#      - name: ğŸ“¥ Checkout Repository
#        uses: actions/checkout@v4
#
#      - name: â˜• Setup Java
#        uses: actions/setup-java@v3
#        with:
#          distribution: 'zulu'
#          java-version: '17'
#
#      - name: ğŸ¦ Setup Flutter
#        uses: subosito/flutter-action@v2
#        with:
#          channel: 'stable'
#          cache: true
#
#      - name: ğŸ“¦ Get Dependencies
#        run: flutter pub get
#
#      - name: ğŸ” Decode Keystore
#        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks
#
#      - name: ğŸ“ Create key.properties
#        run: |
#          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
#          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
#          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
#          echo "storeFile=keystore.jks" >> android/key.properties
#
#      - name: ğŸ—ï¸ Build Signed APK
#        run: flutter build apk --release
#
#      - name: ğŸ“¤ Upload Signed APK
#        uses: actions/upload-artifact@v4
#        with:
#          name: signed-release-apk
#          path: build/app/outputs/flutter-apk/app-release.apk
